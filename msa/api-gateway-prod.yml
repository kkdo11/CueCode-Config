# =========================================
# API-GATEWAY (prod) - Spring Cloud Config
# 목적: 운영/실서비스용. MSA의 단일 진입점(Single Point of Entry) 역할.
# =========================================
server:
  port: 13000                    # 게이트웨이 HTTP 포트
  shutdown: graceful             # 무중단 배포/롤링 업데이트 시 안전


  application:
    name: api-gateway       # Config/로그 식별용 서비스명
  config:
    activate:
      on-profile: prod
  cloud:
    gateway:
      server:
        webflux:
          globalcors:
            cors-configurations:
              '[/**]': # 모든 경로(/**)에 대해 아래 CORS 정책 적용
                allowed-origins: "${CORS_ALLOWED_ORIGINS:http://localhost:14000,http://cuecode.kr,https://cuecode.kr,https://api.cuecode.kr}" # Secret이나 환경변수로 주입 권장
                allowed-methods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - OPTIONS
                allowed-headers: "*"
                allow-credentials: true
          routes:
            # 1. Motion-Service 라우팅
            - id: motion_service_route
              uri: http://motion-service:15000
              predicates:
                - Path=/api/motions/**
              filters:
                - StripPrefix=1

            # 2. User-Service 라우팅 (API 경로별로 세분화)
            - id: user_login_route
              uri: http://user-service:11000
              predicates:
                - Path=/api/login/**
              filters:
                - StripPrefix=1
            - id: user_users_route
              uri: http://user-service:11000
              predicates:
                - Path=/api/users/**
              filters:
                - StripPrefix=1
            - id: user_manager_route
              uri: http://user-service:11000
              predicates:
                - Path=/api/manager/**
              filters:
                - StripPrefix=1
            - id: user_patient_route
              uri: http://user-service:11000
              predicates:
                - Path=/api/patient/**
              filters:
                - StripPrefix=1
            - id: user_user_info_route
              uri: http://user-service:11000
              predicates:
                - Path=/api/user/**
              filters:
                - StripPrefix=1
            - id: user_reg_route
              uri: http://user-service:11000
              predicates:
                - Path=/api/reg/**
              filters:
                - StripPrefix=1

            - id: user_find_id_route
              uri: http://user-service:11000
              predicates:
                - Path=/api/reg/findIdByEmail
              filters:
                - StripPrefix=1 # /api를 제거하여 /reg/findIdByEmail로 전달

            # 3. Front-UI Service 라우팅 (정적 파일 및 HTML 페이지)
            - id: front_ui_route
              uri: http://front-ui-service:14000
              predicates:
                - Path=/, /index.html, /user/**, /css/**, /js/**, /images/**, /motion/**, /patient/**, /manager/**

# Actuator 설정 (최신 방식)
management:
  server:
    port: 13001
    address: 0.0.0.0
  endpoints:
    web:
      exposure:
        include: health
  endpoint:
    health:
      show-details: when_authorized
      probes:
        enabled: true

logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: INFO

jwt:
  secret:
    key: ${JWT_SECRET_KEY}

# Service URIs for Kubernetes environment
service:
  uri:
    user: http://user-service:11000
    front: http://front-ui-service:14000
    motion: http://motion-service:15000